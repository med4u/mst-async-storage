{"version":3,"file":"mst-async-storage.umd.js","sources":["../src/persist.ts","../src/with-async-storage.ts"],"sourcesContent":["const AsyncStorage = require(\"@react-native-community/async-storage\")\nvar CryptoJS = require(\"crypto-js\");\n\nexport async function save(key: string, snapshot: {},cryptoPassword:string) {\n  const data = JSON.stringify(snapshot)\n  await AsyncStorage.setItem(key, CryptoJS.AES.encrypt(data,cryptoPassword).toString())\n}\n\nexport async function load(key: string,cryptoPassword:string) {\n  try {\n    const raw = await AsyncStorage.getItem(key)\n    let bytes = CryptoJS.AES.decrypt(raw,cryptoPassword)\n    let data = bytes.toString(CryptoJS.enc.Utf8)\n    if (raw) {\n      return JSON.parse(data)\n    }\n  } catch {\n    console.log('erreur')\n  }\n\n  return undefined\n}\n","import {\n  flow,\n  applySnapshot,\n  IStateTreeNode,\n  onSnapshot,\n  getSnapshot,\n  getType,\n} from \"mobx-state-tree\"\nimport { load, save } from \"./persist\"\n\nexport interface WithAsyncStorageOptions {\n  /**\n   * The AsyncStorage key name (default: model name).\n   */\n  key?: string\n\n  /**\n   * The Crypto-JS AES password.\n   */\n  CryptoPassword?: string\n\n  /**\n   * Should we monitor for changes via onSnapshot (default: true)?\n   */\n  autoSave?: boolean\n\n  /**\n   * A list of property names. Any other property will be ignored.\n   */\n  only?: string | string[]\n\n  /**\n   * A list of property names that will be filtered if they exist.\n   */\n  except?: string | string[]\n}\n\n/**\n * Adds AsyncStorage support to your model.\n */\nexport const withAsyncStorage = (options: WithAsyncStorageOptions = {}) => (\n  self: IStateTreeNode,\n) => {\n  let disposer: Function\n\n  // setup the default option values\n  const key = options.key || getType(self).name\n  const autoSave = typeof options.autoSave === \"boolean\" ? options.autoSave : true\n\n  const Password = options.CryptoPassword || \"DefaultPassword\"\n\n  /**\n   * Turns on AsyncStorage saving when the snapshot changes.\n   */\n  const enableSaving = () => {\n    disposer && disposer()\n    disposer = onSnapshot(self, snapshot => save(key, filterSnapshotKeys(snapshot),Password))\n  }\n\n  /**\n   * Filters out what data will make it to the persistance layer.\n   *\n   * @param snapshot The snapshot containing our data\n   */\n  function filterSnapshotKeys(snapshot: any) {\n    // sanity\n    if (!snapshot) return snapshot\n\n    // clean up inputs\n    const filterOnly = (typeof options.only === \"string\"\n      ? [options.only]\n      : options.only || []\n    ).filter(Boolean)\n\n    const filterExcept = (typeof options.except === \"string\"\n      ? [options.except]\n      : options.except || []\n    ).filter(Boolean)\n\n    // use the input if there's no filters\n    if (filterOnly.length === 0 && filterExcept.length === 0) return snapshot\n\n    let result: any = {}\n\n    if (filterOnly.length > 0) {\n      // only add certain keys\n      filterOnly.forEach(key => {\n        result[key] = snapshot[key]\n      })\n    } else if (filterExcept.length > 0) {\n      // remove certain keys\n      result = { ...snapshot }\n      filterExcept.forEach(key => {\n        delete result[key]\n      })\n    }\n    return result\n  }\n\n  return {\n    actions: {\n      /**\n       * Loads from async storage.\n       */\n      load: flow(function*() {\n        const data = yield load(key,Password)\n        if (data) {\n          applySnapshot(self, data)\n        }\n\n        // now monitor for changes\n        if (autoSave) {\n          enableSaving()\n        }\n\n        // send back the data\n        return data\n      }) as () => Promise<any | undefined>,\n\n      /**\n       * Saves the snapshot to async storage. This only needs to be\n       * called if autoSave has been turned off.\n       */\n      save: flow(function*() {\n        yield save(key, filterSnapshotKeys(getSnapshot(self)),Password)\n      }),\n\n      beforeDetach() {\n        disposer && disposer()\n      },\n    },\n  }\n}\n"],"names":["getType","onSnapshot","flow","applySnapshot","getSnapshot"],"mappings":"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"}